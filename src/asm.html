<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ашмарин: Ворд текстне тасатасси</title>
<style>
#input  {
	border: 1px solid black;
	height: 200px;
	overflow: auto;
}
#output {
	height: 500px;
	border: 1px solid green;
	overflow: auto;
}
#intermediate {
	display:none;
}
#workingOnIt {
	display:none;
}
</style>
</head>
<body>
<header>
</header>
<section>
<div>Ку пӗр-ик минут илет. Тата Асӑрха: ҫак сайт Google Chrome браузерта анчах тӗрӗслесе пӑхрӑмӑр.<br>
Асӑрха: ӳкерчӗксене ҫак скрипт палласа илмест. Тархасшӑн, кунта сӑмахсене тасатас умӗн, арап сӑмахӗсене ҫырса пар, вӗсем ӳкерчӗклӗ ан пулччӑр.
</div>
<h2>"Таса мар" текст кӗрт:</h2>
<div id="input" contentEditable="true"></div>
<div><span id="workingOnIt">Тӑхта, тасататпӑр...</span><input id="cleanButton" type="button"/ value="Тасат"></div>
</section>
<section id="intermediate"></section>
<br>
Кунта парсер валли текст. Пайлӑш: _$_mirontoli_$_. Кашни рет - ҫӗнӗ сӑмах. INVALIDENTRY пулсан, сӑмах мӗнне ӑнланса пӗлеймерӗмӗр. Кунта ӑӗҫӳ кирилл юникодран анчах.
<br>
<section id="output" contentEditable="true"></section>
<script>

(function() {
	var config = {
		separator: "_$_mirontoli_$_",
		invalidEntryMarker: "INVALIDENTRY"
	};

	var elements = {
		input: document.querySelector("#input"),
		output: document.querySelector("#output"),
		intermediate: document.querySelector("#intermediate"),
		cleanButton: document.querySelector("#cleanButton"),
		workingOnIt: document.querySelector("#workingOnIt")
	};

	var utils = {
		toArray: function(list) {
	    	return Array.prototype.slice.call(list);
		},
		//http://stackoverflow.com/a/3593250
		removeAllAttrs: function(element) {
		    for (var i= element.attributes.length; i-->0;) {
		        var attr = element.attributes[i];
		        if (attr.name !== "dir") {
		          element.removeAttributeNode(attr);
		        }
		    }
		},
		getElementContent: function(element) {
		    var fragment = document.createDocumentFragment();
		    while(element.firstChild) {
		        fragment.appendChild(element.firstChild);
		    }
		    return fragment;
		},
		//http://stackoverflow.com/a/176404
		replaceElementWithItsContent: function(element) {
		    if(element.dir) {
		        return;
		    }
		    var fragment = utils.getElementContent(element);
		    element.parentNode.replaceChild(fragment, element);
		},
		normalizeCharacters: function(text) {
			return text.replace(/ÿ/g, 'ӳ')
						.replace(/Ÿ/g, 'Ӳ')
						.replace(/ç/g, 'ҫ')
						.replace(/Ç/g, 'Ҫ')
						.replace(/ĕ/g, 'ӗ')
						.replace(/Ĕ/g, 'Ӗ')
						.replace(/ă/g, 'ӑ')
						.replace(/Ă/g, 'Ӑ');

		},
		joinSameSiblings: function(paragraph) {
		    var childNodes = paragraph.childNodes;
		    if (childNodes.length < 1) {
		    	return;
		    }
		    var firstNode = childNodes[0];
		    var currentNodeName = firstNode.nodeName;
		    var index = 1; //we start from second to compare with the first
		    var currentNode;
		    var previousNode;

		    //remove if comment
		    if(firstNode.nodeType === 8) {
		    	firstNode.remove();
		    }
		    while(index < childNodes.length) {
		        currentNode = childNodes[index];
		        previousNode = childNodes[index-1];
		        if(currentNode.nodeType === 8) {
		        	currentNode.remove();
		        }
		        else if(currentNode.nodeName === previousNode.nodeName) {
		            if (currentNode.nodeType === 3) {
		                //it is just text
		                previousNode.nodeValue = previousNode.nodeValue + currentNode.nodeValue;
		            }
		            else {
		            	var content = utils.getElementContent(currentNode);

try {
		            	previousNode.appendChild(content);
}
catch(ex) {
	console.log("\n\n======================================")
console.log(previousNode.nodeType, previousNode.nodeName);
console.log(ex);
}
		                //put content into the previous sibling
		                //var fragment = getElementContent(childNodes[index]);
		                //childNodes[index-1].appendChild(fragment);
		                //paragraph.replaceChild(fragment, childNodes[index-1]);
		            }
		            currentNode.remove();
		        }
		        else {
		            index++;
		        }
		    }
		},
		parseParagraph: function(paragraph) {
			//first child should be entry key:
			var entryKeyElement = paragraph.firstChild;
			var entry;
			var entryKey = config.invalidEntryMarker;
			var entryValue;
			//it should exist, it should "B" node and it should contain inner Text
			if (entryKeyElement && entryKeyElement.nodeName === "B" && entryKeyElement.innerText) {
				entryKey = entryKeyElement.innerText.split(',')[0];
			}
			//remove comments http://stackoverflow.com/a/5654032
			var entryValue = paragraph.innerHTML.replace(/<!--[\s\S]*?-->/g, '');
			//check entry key again.
			var entryKeyAgain = paragraph.innerText.split(",")[0];
			if (entryKey !== entryKeyAgain) {
				entryKey = config.invalidEntryMarker;
			}
			var replacedEntryValue = entryValue.replace(/<sub>/gi, '[sub]')
						.replace(/<\/sub>/gi, '[/sub]')
						.replace(/<sup>/gi, '[sup]')
						.replace(/<\/sup>/gi, '[/sup]')
						.replace(/<b>/gi, '[b]')
						.replace(/<\/b>/gi, '[/b]')
						.replace(/<i>/gi, '[i]')
						.replace(/<\/i>/gi, '[/i]')
						.replace(/<span dir="RTL">/gi, '[rtl]')
						.replace(/<\/span>/gi, '[/rtl]');

			entry = utils.normalizeCharacters(entryKey) + config.separator + utils.normalizeCharacters(replacedEntryValue);
			ui.printOutput(entry);
			console.log(entry);
			console.log("-----------------------------------");
		}
	};

	var ui = {
		toggleNotification: function() {
			if (!cleanButton.disabled)  {
				workingOnIt.style.display = "inline";
				cleanButton.disabled = true;
			}
			else  {
				workingOnIt.style.display = "none";
				cleanButton.removeAttribute("disabled");
			}
		},
		emptyOutputAndIntermediate: function() {
			elements.intermediate.innerHTML = "";
			elements.output.innerHTML = "";
		},
		printOutput: function(textRow){
			var node = document.createTextNode(textRow);
			var br = document.createElement("br");
			elements.output.appendChild(node);
			elements.output.appendChild(br);
		}
	};

	
	var steps = {
		removeAllAttrs: function() {
			var allElements = elements.intermediate.querySelectorAll("*");
			var allElementsAsArray = utils.toArray(allElements);
			allElementsAsArray.forEach(utils.removeAllAttrs);
		},
		removeEmptyElements: function() {
			var allElements = elements.intermediate.querySelectorAll("*");
			var allElementsAsArray = utils.toArray(allElements);
			allElementsAsArray.forEach(function(elem) { if (elem.innerText === "") { elem.remove(); }});
		},
		//not needed on paste
		removePageBreaksDivs: function() {
			var divs = elements.intermediate.querySelectorAll(":scope > div");
			var divsAsArray = Array.prototype.slice.call(divs);
			divsAsArray.forEach(utils.replaceElementWithItsContent);
		},
		removeUnneededSpans: function() {
			var spans = elements.intermediate.querySelectorAll("span");
			var spansAsArray = utils.toArray(spans);
			spansAsArray.forEach(utils.replaceElementWithItsContent);
		},
		removeEmptyParagraphs: function() {
			var paragraphs = elements.intermediate.querySelectorAll("p");
			var paragraphsAsArray = utils.toArray(paragraphs);
			paragraphsAsArray.forEach(function(p) {
			    if (p.innerText.trim().length === 0) {
			        p.remove();
			    }
			});
		},
		removeSubAndSupsWithOnlySpace: function() {
			var subsAndSups = elements.intermediate.querySelectorAll("sub,sup");
			var subsAndSupsAsArray = utils.toArray(subsAndSups);
			subsAndSupsAsArray.forEach(function(s) {
				if (s.innerText === " ") {
					s.parentNode.replaceChild(document.createTextNode(" "), s);
				}
			});
		},
		joinSameSiblings: function() {
			//about :scope http://stackoverflow.com/a/21126966
			var paragraphs = elements.intermediate.querySelectorAll(":scope > p");
			var paragraphsAsArray = utils.toArray(paragraphs);
			paragraphsAsArray.forEach(utils.joinSameSiblings);
		},
		prepareForOutput: function() {
			var paragraphs = elements.intermediate.querySelectorAll(":scope > p");
			var paragraphsAsArray = utils.toArray(paragraphs);
			paragraphsAsArray.forEach(utils.parseParagraph);
		}
	};

	function clean(e)  {
		ui.toggleNotification();
		ui.emptyOutputAndIntermediate();
		elements.intermediate.innerHTML = elements.input.innerHTML;
		steps.removeAllAttrs();
		steps.removeEmptyElements();
		steps.removeUnneededSpans();
		steps.removeEmptyParagraphs();
		steps.removePageBreaksDivs();
		steps.removeSubAndSupsWithOnlySpace();
		steps.joinSameSiblings();
		steps.prepareForOutput();

		ui.toggleNotification();
	}
	cleanButton.addEventListener("click", clean);

	//temporary
	window.config = config;
	window.elements = elements;
	window.utils = utils;
	window.ui = ui;
	window.steps = steps;
})();



</script>
</body>
</html>